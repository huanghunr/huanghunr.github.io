<!DOCTYPE html><html lang="zh-cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>2024CtfNewStar Week4 Re-wp | huanghunr's Blog</title><meta name="author" content="huanghunr"><meta name="copyright" content="huanghunr"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#FFF8F0"><meta name="description" content="CTFNewStar2024 Week4 题目Re的Witeup">
<meta property="og:type" content="article">
<meta property="og:title" content="2024CtfNewStar Week4 Re-wp">
<meta property="og:url" content="http://example.com/2024/11/23/CTFNewStar2024-Week5-wp/index.html">
<meta property="og:site_name" content="huanghunr&#39;s Blog">
<meta property="og:description" content="CTFNewStar2024 Week4 题目Re的Witeup">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/tx4.jpg">
<meta property="article:published_time" content="2024-11-22T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-24T16:00:00.000Z">
<meta property="article:author" content="huanghunr">
<meta property="article:tag" content="re,WriteUp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/tx4.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "2024CtfNewStar Week4 Re-wp",
  "url": "http://example.com/2024/11/23/CTFNewStar2024-Week5-wp/",
  "image": "http://example.com/img/tx4.jpg",
  "datePublished": "2024-11-22T16:00:00.000Z",
  "dateModified": "2025-08-24T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "huanghunr",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://example.com/2024/11/23/CTFNewStar2024-Week5-wp/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#402218')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#FFF8F0')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '2024CtfNewStar Week4 Re-wp',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/tx4.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">41</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">huanghunr's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">2024CtfNewStar Week4 Re-wp</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">2024CtfNewStar Week4 Re-wp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-11-22T16:00:00.000Z" title="Created 2024-11-23 00:00:00">2024-11-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-24T16:00:00.000Z" title="Updated 2025-08-25 00:00:00">2025-08-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/WriteUp/">WriteUp</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">2.8k</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="MY-ARM"><a href="#MY-ARM" class="headerlink" title="MY_ARM"></a>MY_ARM</h2><p>用ida打开我们就可以发现输入，跟踪数据，就可以找到对比函数和加密函数，里面有密钥和密文。加密函数就是一个原生的tea加密，去解密，发现解密的是错误的，于是我们进行动调寻找，被修改的密文和密钥。用qume虚拟机运行程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-arm -g 23946 文件</span><br></pre></td></tr></table></figure>
<p>再次查看就可以找到被修改的密文和密钥,直接tea解密就行，值得注意的是在这个tea解密时，v1,v2的数据类型应该是int确保要有符号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">decrypt</span><span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* k)</span> &#123;</span><br><span class="line">	<span class="type">int</span> sum = <span class="number">0x9E3779B9</span> * <span class="number">32</span>;</span><br><span class="line">	<span class="type">int</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>],  i;	</span><br><span class="line">	<span class="type">uint32_t</span> delta = <span class="number">0x9E3779B9</span>;</span><br><span class="line">	<span class="type">uint32_t</span> k0 = k[<span class="number">0</span>], k1 = k[<span class="number">1</span>], k2 = k[<span class="number">2</span>], k3 = k[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">		v1 -= ((v0 &lt;&lt; <span class="number">4</span>) + k2) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="number">5</span>) + k3);</span><br><span class="line">		v0 -= ((v1 &lt;&lt; <span class="number">4</span>) + k0) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="number">5</span>) + k1);</span><br><span class="line">		sum -= delta;</span><br><span class="line">	&#125;</span><br><span class="line">	v[<span class="number">0</span>] = v0; v[<span class="number">1</span>] = v1;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> v[] = &#123; <span class="number">0xA0F8CB44</span>, <span class="number">0xF82F83CF</span>, <span class="number">0xA55E48C2</span>, <span class="number">0x7A26E00A</span>, <span class="number">0xF1E354C9</span>, <span class="number">0x687D9915</span>, <span class="number">0xF88816E8</span>, <span class="number">0x90878E86</span>,</span><br><span class="line">	<span class="number">0x3AB06298</span>, <span class="number">0xCBCFE78B</span>, <span class="number">0x578F0F50</span>, <span class="number">0xC39E3C65</span>, <span class="number">0xBBE92B84</span>, <span class="number">0x128A2CA2</span>, <span class="number">0xDB8F03F5</span>, <span class="number">0x8482F8E2</span> &#125;;</span><br><span class="line">	<span class="type">uint32_t</span> k[<span class="number">4</span>] = &#123; <span class="number">0x11223344</span>, <span class="number">0x55667788</span>, <span class="number">0x9900AABB</span>, <span class="number">0xCCDDEEFF</span> &#125;;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">		decrypt(v+i, k);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, *((<span class="type">unsigned</span> <span class="type">char</span>*)v + i));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ohn-flutter"><a href="#ohn-flutter" class="headerlink" title="ohn_flutter!!!"></a>ohn_flutter!!!</h2><p>用blutter进行解包，在”asm\ohn_flutter”目录下，把这个文件夹在vscode里面打开，我们可以看到汇编形式的源代码，可以尝试用关键的字符串搜索，找到程序的主逻辑处。然后我们可以读汇编中调用的函数，和一些关键参数，来查看加密函数的名字，和地址。然后在ida中分析。搜索字符串，发现主逻辑在一个_bulid的函数里面，用地址在ida中找到这个函数，发现是一坨，也不好找到逻辑。于是回到汇编中继续往下看，这个时候我们看到了一个”key”,但是查找后也没有什么收获。继续往下看我们看到一个函数里面调用了许多加密函数，用ida分析，这就是加密的主函数，一下就看到一个AES加密。这里面有些函数出现了很多次，感觉是程序自带的函数，把这些函数排除后，我们一个个进去看，在”ohn_flutter_doi_::jumppp_2fe3c8()”深入挖掘，我们还可以看到在”ohn_flutter_drink_drink::_encryptUint32List_2fe5ec()”函数里面有XXTEA加密的特征，在下图的上面还有一个”v18 &#x3D; v14 &#x2F; v16 + 6;”<br><img src="https://huanghunr-blog.oss-cn-hangzhou.aliyuncs.com/img/Snipaste_2024-12-02_19-55-00.png" alt="Snipaste_2024-12-02_19-55-00"><br>往后面看，只有一个base64加密，再后面就没有其他加密方法了。接下来的步骤就是找出密文和密钥，以及iv。</p>
<p>在这里我们需要一个真机来进行ARM调试，用frida进行hook或者IDA调试。这里我们用frida进行hook。</p>
<p>首先我们来hookXXtea的密钥，根据XXtea的加密逻辑，我们可以知道密钥的偏移量里面有一个”&amp;3”,我们找到这里。<br><img src="https://huanghunr-blog.oss-cn-hangzhou.aliyuncs.com/img/Snipaste_2024-12-02_20-25-20.png" alt="Snipaste_2024-12-02_20-25-20"><br>但是偏移量有点大，所以我们直接在寄存器里找密钥，在汇编里找到和+16有关x29的寄存器，很显然就是X12。<br><img src="https://huanghunr-blog.oss-cn-hangzhou.aliyuncs.com/img/Snipaste_2024-12-02_20-28-10.png" alt="Snipaste_2024-12-02_20-28-10"><br>然后我们把地址复制下来，就可以写hook脚本读取寄存器数值了，脚本如下。<br>用类似的方法可以拿到AES加密的密钥和iv。<br>最后我们要找密文。密文其实在java层里，但是最后有一个check函数，在这个函数里面一定会把密文传入比较，所以我们同样可以用上面的方法获取寄存器的值来获取密文，只不过我们要猜一下是哪个寄存器。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ShowNullField</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MaxDepth</span> = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">var</span> libapp = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="property">att</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onLibappLoaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fn_addr = <span class="number">0x2FE7F0</span>;   <span class="comment">//填写地址偏移</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(libapp.<span class="title function_">add</span>(fn_addr), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> r1 = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x12</span>;  <span class="comment">//x12是要打的印寄存器</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(r1)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title function_">ptr</span>(r1), &#123; <span class="attr">length</span>: <span class="number">100</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;))  <span class="comment">//打印寄存器</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tryLoadLibapp</span>(<span class="params"></span>) &#123;  <span class="comment">//初始化</span></span><br><span class="line">    libapp = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libapp.so&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (libapp === <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">setTimeout</span>(tryLoadLibapp, <span class="number">500</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="title function_">onLibappLoaded</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">tryLoadLibapp</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="jun…junkcode？"><a href="#jun…junkcode？" class="headerlink" title="jun…junkcode？"></a>jun…junkcode？</h2><p>打开后去除一个jz，jnz的花指令。我们可以看到main函数的加密流程，就是一个对表的异或和加减，写出解密脚本发现答案并不正确，结合题目来看我们再次去仔细的看看main前面的其他函数，同时我们也可以看看import，里面导入了许多WindowsAPI的函数。在开头，我们可以看到一个sub_4017A9(“%43s”, byte_408A40);函数，这个函数里面藏了一些东西，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">sub_4017A9</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, __int64 a2, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">  _UNKNOWN *retaddr;  <span class="comment">//一个地址指针，存储了main函数call的返回地址，即call的下一个地址</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">scanf</span>(a1, a2);  <span class="comment">//获取输入</span></span><br><span class="line">  *((_QWORD *)qword_408A20[<span class="number">0</span>] + <span class="number">1</span>) = &amp;retaddr;  <span class="comment">//记录返回地址到变量中</span></span><br><span class="line">  CreateProcessA(ApplicationName, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, &amp;StartupInfo, (LPPROCESS_INFORMATION)&amp;hObject); <span class="comment">//以ApplicationName创建一个子进程，把句柄保存到hObject</span></span><br><span class="line">  WaitForSingleObject(hObject, <span class="number">0xFFFFFFFF</span>); <span class="comment">//等待句柄记的结束，0xFFFFFFFF表示等待时间为无限，</span></span><br><span class="line">  UnmapViewOfFile(qword_408A20[<span class="number">0</span>]); <span class="comment">//取消文件映射</span></span><br><span class="line">  CloseHandle(qword_408A70);  <span class="comment">//关闭句柄</span></span><br><span class="line">  CloseHandle(hObject);<span class="comment">//关闭hObject句柄</span></span><br><span class="line">  <span class="keyword">return</span> CloseHandle(*(&amp;hObject + <span class="number">1</span>)); <span class="comment">//关闭句柄</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里涉及到了文件映射的概念，UnmapViewOfFile(qword_408A20[0]); 这个函数取消了一个文件映射，我们查看qword_408A20[0]这个文件的交叉引用，我们可以找到另一个函数sub_401550()。</p>
<blockquote>
<p>Windows文件映射:创建并打开一个文件，把这个文件映射到内存中，通过读写这个文件以达到让不同进程共享内存的目的。</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">sub_401550</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DWORD *v0; <span class="comment">// rbx</span></span><br><span class="line">  DWORD result; <span class="comment">// eax</span></span><br><span class="line">  __int64 Buffer; <span class="comment">// [rsp+30h] [rbp-50h] BYREF</span></span><br><span class="line">  HANDLE hProcess; <span class="comment">// [rsp+38h] [rbp-48h]</span></span><br><span class="line"></span><br><span class="line">  qword_408A70[<span class="number">0</span>] = <span class="built_in">OpenFileMappingA</span>(<span class="number">0xF001Fu</span>, <span class="number">0</span>, <span class="string">&quot;jun...junkcode?&quot;</span>);  <span class="comment">//打开一个名为jun...junkcode?的映射对象，返回文件的句柄</span></span><br><span class="line">  <span class="keyword">if</span> ( qword_408A70[<span class="number">0</span>] ) <span class="comment">//判断是否打开成功</span></span><br><span class="line">  &#123;</span><br><span class="line">    qword_408A20[<span class="number">0</span>] = <span class="built_in">MapViewOfFile</span>(qword_408A70[<span class="number">0</span>], <span class="number">0xF001Fu</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x18uLL</span>);<span class="comment">//把映射对象映射到内存中，返回一个指针</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">DebugActiveProcess</span>(*(_DWORD *)qword_408A20[<span class="number">0</span>]) ) <span class="comment">//映射内存中的进程进行调试</span></span><br><span class="line">    &#123;</span><br><span class="line">      hProcess = <span class="built_in">OpenProcess</span>(<span class="number">0x1F0FFFu</span>, <span class="number">0</span>, *(_DWORD *)qword_408A20[<span class="number">0</span>]);<span class="comment">//打开进程并获得所有的控制权限</span></span><br><span class="line">      Buffer = *((_QWORD *)qword_408A20[<span class="number">0</span>] + <span class="number">2</span>); <span class="comment">//赋值</span></span><br><span class="line">      <span class="built_in">WriteProcessMemory</span>(hProcess, *((LPVOID *)qword_408A20[<span class="number">0</span>] + <span class="number">1</span>), &amp;Buffer, <span class="number">8uLL</span>, <span class="number">0LL</span>);<span class="comment">//写内存，把buffer的值写入*((LPVOID *)qword_408A20[0] + 1)中</span></span><br><span class="line">      <span class="built_in">DebugActiveProcessStop</span>(*(_DWORD *)qword_408A20[<span class="number">0</span>]);<span class="comment">//停止调试</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">UnmapViewOfFile</span>(qword_408A20[<span class="number">0</span>]);<span class="comment">//取消映射内存</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(qword_408A70[<span class="number">0</span>]);<span class="comment">//关闭句柄</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hProcess);<span class="comment">//关闭句柄</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);<span class="comment">//推出进程</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">GetModuleFileNameA</span>(<span class="number">0LL</span>, ApplicationName, <span class="number">0x104u</span>);<span class="comment">//获取当前程序路径</span></span><br><span class="line">  qword_408A70[<span class="number">0</span>] = <span class="built_in">CreateFileMappingA</span>((HANDLE)<span class="number">0xFFFFFFFFFFFFFFFFLL</span>, <span class="number">0LL</span>, <span class="number">4u</span>, <span class="number">0</span>, <span class="number">0x18u</span>, <span class="string">&quot;jun...junkcode?&quot;</span>);<span class="comment">//创建映射文件对象</span></span><br><span class="line">  qword_408A20[<span class="number">0</span>] = <span class="built_in">MapViewOfFile</span>(qword_408A70[<span class="number">0</span>], <span class="number">0xF001Fu</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x18uLL</span>);<span class="comment">//映射文件到内存中</span></span><br><span class="line">  *((_QWORD *)qword_408A20[<span class="number">0</span>] + <span class="number">2</span>) = <span class="number">4201097LL</span>;<span class="comment">//把4201097LL;赋值给*((_QWORD *)qword_408A20[0] + 2)，上文中是buffer。</span></span><br><span class="line">  v0 = (DWORD *)qword_408A20[<span class="number">0</span>];<span class="comment">//保存指针到v0</span></span><br><span class="line">  result = <span class="built_in">GetCurrentProcessId</span>();<span class="comment">//获取进程ID</span></span><br><span class="line">  *v0 = result;<span class="comment">//把进程ID赋值给v0指针，即是为qword_408A20[0]。</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数整个逻辑的大概解释，就是父进程执行打开失败的内容，子进程执行打开成功的内容。<br>那么这个函数的逻辑就是父进程把自己的返回地址和另一个返回地址映射到内存中，然后被子进程替换，从而使父进程的返回地址改变到4201097。<br>加密逻辑已经清楚，但是我们还是不知道总程序的逻辑。接下来我们分析一下这个函数的交叉引用来寻找总逻辑。</p>
<h4 id="总逻辑"><a href="#总逻辑" class="headerlink" title="总逻辑"></a>总逻辑</h4><ul>
<li>对sub_401550()引用我们可以找到一个数组__int64 qword_4032A0[];<br><img src="https://huanghunr-blog.oss-cn-hangzhou.aliyuncs.com/img/Snipaste_2024-12-09_17-33-52.png"><br>在这个数组中记录了sub_401550()的地址，继续寻找数组的引用，继续往下找我们可以找到sub_401B50()</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_401B50</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">void</span> (**v0)(<span class="type">void</span>); <span class="comment">// rbx</span></span><br><span class="line">  __int64 *v1; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; qword_4032A0[i + <span class="number">1</span>]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = (<span class="built_in">void</span> (**)(<span class="type">void</span>))&amp;qword_4032A0[i];</span><br><span class="line">    v1 = &amp;qword_4032A0[i - (<span class="type">unsigned</span> __int64)(i - <span class="number">1</span>) - <span class="number">1</span>];</span><br><span class="line">    <span class="built_in">do</span></span><br><span class="line">      (*v0--)();</span><br><span class="line">    <span class="keyword">while</span> ( v0 != (<span class="built_in">void</span> (**)(<span class="type">void</span>))v1 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_401510</span>(loc_401B10);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数把qword_4032A0[]数组的指针依次保存到v0执行，包括我们的sub_401550()函数。我们继续往上跟，最终会跟到main函数里面<br><img src="https://huanghunr-blog.oss-cn-hangzhou.aliyuncs.com/img/Snipaste_2024-12-09_18-13-55.png"></p>
<p>这下就真相大白了，在进入main函数时程序也就是父进程，先执行了sub_401550()，因为没有创建映射对象所以会走打开失败的分支，然后创建映射对象，并映射内存，把上述的数据写入内存。接下来执行到输入的函数sub_4017A9()，创建子进程(创建的子进程与父程序是相同文件)并等待子进程的结束。这期间子进程因为有了父进程的创建映射对象，子进程会走成功打开的分支，修改父进程的返回地址，从而改变程序的执行逻辑，我们找到最终执行的位置，发现真正的加密方法。</p>
<p>那么接下来就是对最后的加密进行分析了，我们来到0x401A89处，也就是父进程返回被修改后到的函数。但是我们发现一个问题，这里是一大堆字节码，我们c键恢复成代码后勉强可以看到汇编，不能反编译。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>0000000000401A90 loc_401A90:                             <span class="comment">; CODE XREF: .text:0000000000401B00↓j</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401A90                 <span class="keyword">movsx</span>   <span class="built_in">eax</span>, <span class="built_in">bl</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401A93</span><br><span class="line"><span class="symbol">.text:</span>0000000000401A93 loc_401A93:                             <span class="comment">; CODE XREF: .text:0000000000401A69↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401A93                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">41</span> </span><br><span class="line"><span class="symbol">.text:</span>0000000000401A98                 <span class="keyword">sub</span>     <span class="built_in">edx</span>, <span class="built_in">eax</span> <span class="comment">;41减去下标</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401A9A                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401A9C                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, byte_408A40</span><br><span class="line"><span class="symbol">.text:</span>0000000000401AA3                 <span class="keyword">cdqe</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AA5                 <span class="keyword">movzx</span>   <span class="built_in">r8d</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rdx</span>+<span class="built_in">rax</span>]</span><br><span class="line"><span class="symbol">.text:</span>0000000000401<span class="keyword">AAA</span>                 <span class="keyword">movsx</span>   <span class="built_in">eax</span>, <span class="built_in">bl</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401<span class="keyword">AAD</span>                 <span class="keyword">lea</span>     <span class="built_in">ecx</span>, [<span class="built_in">rax</span>+<span class="built_in">rax</span>]  <span class="comment">;下标的2倍</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AB0                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">818089009</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AB5                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AB7                 <span class="keyword">imul</span>    <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AB9                 <span class="keyword">sar</span>     <span class="built_in">edx</span>, <span class="number">3</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401ABC                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401ABE                 <span class="keyword">sar</span>     <span class="built_in">eax</span>, <span class="number">31</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AC1                 <span class="keyword">sub</span>     <span class="built_in">edx</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AC3                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AC5                 <span class="keyword">imul</span>    <span class="built_in">eax</span>, <span class="number">42</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AC8                 <span class="keyword">sub</span>     <span class="built_in">ecx</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401ACA                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401ACC                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, byte_408A40</span><br><span class="line"><span class="symbol">.text:</span>0000000000401AD3                 <span class="keyword">cdqe</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AD5                 <span class="keyword">movzx</span>   <span class="built_in">edx</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rdx</span>+<span class="built_in">rax</span>] <span class="comment">;input[(2*i)%42]</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AD9                 <span class="keyword">movsx</span>   <span class="built_in">eax</span>, <span class="built_in">bl</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401<span class="keyword">ADC</span>                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="number">41</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AE1                 <span class="keyword">sub</span>     <span class="built_in">ecx</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AE3                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AE5                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="built_in">r8d</span>  <span class="comment">;获取input[41-i]</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AE8                 <span class="keyword">xor</span>     <span class="built_in">ecx</span>, <span class="built_in">edx</span>  <span class="comment">;异或</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AEA                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, byte_408A40</span><br><span class="line"><span class="symbol">.text:</span>0000000000401AF1                 <span class="keyword">cdqe</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AF3                 <span class="keyword">mov</span>     [<span class="built_in">rdx</span>+<span class="built_in">rax</span>], <span class="built_in">cl</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AF6                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AF8                 <span class="keyword">add</span>     <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AFB                 <span class="keyword">mov</span>     <span class="built_in">ebx</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401AFD                 <span class="keyword">cmp</span>     <span class="built_in">bl</span>, <span class="number">29h</span> <span class="comment">;比较是判断否加密完毕</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000401B00                 <span class="keyword">jle</span>     short loc_401A90</span><br><span class="line"><span class="symbol">.text:</span>0000000000401B02                 <span class="keyword">jmp</span>     loc_4019F9</span><br></pre></td></tr></table></figure>
<p>其实这里可以借助动调分析。但是这个题是有反调试的，在上面的sub_401550()函数中，要子进程调试父进程，如果在这之前父进程被其他进程调试了，子进程就无法附加调试，那自然无法执行正确的逻辑。我们已经知道子程序的逻辑就是修改父进程的返回地址，我们可以手动修改。在retn处下断点，然后修改EIP的值为0x401A89；这样就可以直接跳到加密部分分析了。<br>这里我们经过短暂（雾）的分析汇编盯针出主要的加密逻辑。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++) &#123;</span><br><span class="line">    input[<span class="number">41</span> - i] ^= input[(<span class="number">2</span>* i)%<span class="number">42</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写出解密脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> mm[<span class="number">42</span>] = &#123;</span><br><span class="line">    <span class="number">0x34</span>, <span class="number">0x6C</span>, <span class="number">0x60</span>, <span class="number">0x33</span>, <span class="number">0x15</span>, <span class="number">0x3B</span>, <span class="number">0x74</span>, <span class="number">0x38</span>, <span class="number">0x5E</span>, <span class="number">0x6A</span>, <span class="number">0x53</span>, <span class="number">0x05</span>, <span class="number">0x31</span>, <span class="number">0x1C</span>, <span class="number">0x43</span>, <span class="number">0x35</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0x58</span>, <span class="number">0x4A</span>, <span class="number">0x12</span>, <span class="number">0x39</span>, <span class="number">0x3B</span>, <span class="number">0x35</span>, <span class="number">0x5E</span>, <span class="number">0x3A</span>, <span class="number">0x21</span>, <span class="number">0x08</span>, <span class="number">0x1B</span>, <span class="number">0x44</span>, <span class="number">0x00</span>, <span class="number">0x7C</span>, <span class="number">0x26</span>,</span><br><span class="line">    <span class="number">0x6E</span>, <span class="number">0x5D</span>, <span class="number">0x54</span>, <span class="number">0x0C</span>, <span class="number">0x01</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x1F</span>, <span class="number">0x52</span>, <span class="number">0x1B</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">41</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">        mm[<span class="number">41</span>-i] ^= mm[(<span class="number">2</span> * i) % <span class="number">42</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, mm[<span class="number">41</span>-i]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag&#123;G00d_jOb_!_7h1s_i5_nOt_0nIy_junkc0d3&#125;</span></span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">huanghunr</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/11/23/CTFNewStar2024-Week5-wp/">http://example.com/2024/11/23/CTFNewStar2024-Week5-wp/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/re-WriteUp/">re,WriteUp</a></div><div class="post-share"><div class="social-share" data-image="/img/tx4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/11/24/%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E8%B5%9B%E9%80%89%E6%8B%94%E8%B5%9Bre/" title="2024强网杯青少年赛选拔赛Re-wp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">2024强网杯青少年赛选拔赛Re-wp</div></div><div class="info-2"><div class="info-item-1">原题提取码：95lk  EnterGame一个chacha20加密，尝试用脚本解密不过好像不行，不知道是哪里的问题，可能是我密钥找错了。chacha20本质就是一个异或，我们可以把密文写入加密一次就可以得到原文。  下断点在加密入口处，提取密文注意点进去把密文全部提取，一共有48字节“5E 13 AA D3 87 75 2B 7A 1B 16 04 A3 49 7E 1D D26B 5D 58 40 5E 44 63 59 48 51 0D 54 5E 58 55 58 AD 82 AF DC E7 AB 58 5D CE C1 FD F7 FF 7F 00 00”。我们再次动调，输入48字节数据作为输入，然后再次在加密入口处断点，修改input的值。  用ida自带的chage byte就可以每十六字节进行修改。在比较的位置下一个断点继续运行查看s1的值就可以得到flag。   Flip_over看java层主逻辑在validateAndEncrypt()函数里，在so文件里找到这个函数，大概逻辑的是取flagflag这个字符串作为密钥把”a4c3f8927d9b8e6d6e4...</div></div></div></a><a class="pagination-related" href="/2024/11/10/2024%E6%B5%99%E6%B1%9F%E7%9C%81%E7%9C%81%E8%B5%9B/" title="2024浙江省省赛 Re-wp+复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">2024浙江省省赛 Re-wp+复现</div></div><div class="info-2"><div class="info-item-1">(・∀・)つ原题(提取码: d9sa) 初赛ezre一个python字节码文件，可以用pycdas查看字节码。我们借此来分析一下python字节码文件的结构。 涉及到闭包函数的内容，总的来说闭包就是函数被定义在了函数里面。 闭包，看这一篇就够了——带你看透闭包的本质，百发百中-CSDN博客 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/04/2025%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E7%AB%9E%E8%B5%9B-PC%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8-%E5%88%9D%E8%B5%9B/" title="2025腾讯游戏安全技术竞赛-PC客户端安全-初赛（复现）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-04</div><div class="info-item-2">2025腾讯游戏安全技术竞赛-PC客户端安全-初赛（复现）</div></div><div class="info-2"><div class="info-item-1">复现题目旨在了解题目的逻辑~~~~，可能与真正的解题流程有出入 先看main函数 首先，加载了ACEDriverSDK，里面有许多函数，我们先标出函数的作用。  在虚表中我们可以看到下面这两个函数，一个是用于后面base58表的初始化的，还有一个就是反调试函数。  根据作用大致恢复一下结构体(命名函数时会自动修改)。 12345678910111213141516struct ACEDriverSDK_vftable&#123;  void *creat_vftable;  __int64 (__fastcall *initserver)(ACEDriverSDK_vftable **a1, char *a2, __int64 a3);  __int64 (__fastcall *closeserver)(ACEDriverSDK_vftable **a1, __int64 a2);  _BOOL8 (__fastcall *startserver)(ACEDriverSDK_vftable **a1, SC_HANDLE hSCManager, const WCHAR *lpS...</div></div></div></a><a class="pagination-related" href="/2024/11/10/2024%E6%B5%99%E6%B1%9F%E7%9C%81%E7%9C%81%E8%B5%9B/" title="2024浙江省省赛 Re-wp+复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-10</div><div class="info-item-2">2024浙江省省赛 Re-wp+复现</div></div><div class="info-2"><div class="info-item-1">(・∀・)つ原题(提取码: d9sa) 初赛ezre一个python字节码文件，可以用pycdas查看字节码。我们借此来分析一下python字节码文件的结构。 涉及到闭包函数的内容，总的来说闭包就是函数被定义在了函数里面。 闭包，看这一篇就够了——带你看透闭包的本质，百发百中-CSDN博客 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153...</div></div></div></a><a class="pagination-related" href="/2024/10/26/CTFNewStar2024-Week1-wp/" title="2024CtfNewStar Week1 Re&amp;Web-wp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-26</div><div class="info-item-2">2024CtfNewStar Week1 Re&amp;Web-wp</div></div><div class="info-2"><div class="info-item-1">reverse(・∀・)つ原题  base64Die 发现是 PE64，直接丢入 ide64，函数名混乱，直接 shift+f12，查找用”Enter the flag: “ 进入主函数，发现输入的值 str 为 26 位然后被 sub_7FF706EE14E0(Str, 26, Str1)加密输出为 str1，再与 g84Gg6m2ATtVeYqUZ9xRnaBpBvOVZYtj+Tc&#x3D;比较相等即 str 是 flag 值.进入sub_7FF706EE14E0()函数，再由题目提示的 base64 丁帧为 base64 加密函数，并找到了一个字符串 WHydo3sThiS7ABLElO0k5trange+CZfVIGRvup81NKQbjmPzU4MDc9Y6q2XwFxJ&#x2F; ,一眼就是密钥 . 直接用密钥 base64 解密得 flag  ezAndroidStudyapk 先安装看一看，全是提示就跟着提示来activity 有个 work.pangbai.ezandroidstudy.Homo 的页面,直接搜索进入拿下 flag 第一段 flag{Y0u...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/tx4.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">huanghunr</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">41</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/huanghunr"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MY-ARM"><span class="toc-number">1.</span> <span class="toc-text">MY_ARM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ohn-flutter"><span class="toc-number">2.</span> <span class="toc-text">ohn_flutter!!!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jun%E2%80%A6junkcode%EF%BC%9F"><span class="toc-number">3.</span> <span class="toc-text">jun…junkcode？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E9%80%BB%E8%BE%91"><span class="toc-number">3.0.1.</span> <span class="toc-text">总逻辑</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/10/D3CTF2025/" title="D^3CTF2025 Re-wp&amp;复现">D^3CTF2025 Re-wp&amp;复现</a><time datetime="2025-07-09T16:00:00.000Z" title="Created 2025-07-10 00:00:00">2025-07-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/10/r3ctf2025/" title="2025 r3CTF Re-部分复现">2025 r3CTF Re-部分复现</a><time datetime="2025-07-09T16:00:00.000Z" title="Created 2025-07-10 00:00:00">2025-07-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/21/ISCC-re/" title="2025ISCC 复现">2025ISCC 复现</a><time datetime="2025-05-20T16:00:00.000Z" title="Created 2025-05-21 00:00:00">2025-05-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/19/miniLCTF2025/" title="2025miniLCTF 部分Re-wp+复现">2025miniLCTF 部分Re-wp+复现</a><time datetime="2025-05-18T16:00:00.000Z" title="Created 2025-05-19 00:00:00">2025-05-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/01/%E7%9F%A9%E9%98%B5%E6%93%8D%E4%BD%9C%E5%AD%A6%E4%B9%A0/" title="矩阵逆向初步学习">矩阵逆向初步学习</a><time datetime="2025-04-30T16:00:00.000Z" title="Created 2025-05-01 00:00:00">2025-05-01</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient( 135deg, #FFD89B 10%, #FCA17D 100%);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By huanghunr</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/"><span>桂ICP备2024049894号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>